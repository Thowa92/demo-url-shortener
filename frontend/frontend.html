<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>

<body>


    <h1>Url Mappings</h1>

    <table id="mappingTable" class="table table-dark">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Url Short</th>
                <th scope="col">Url Long</th>
                <th scope="col">Number of calls</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <form id="addNewMappingForm" action="http://localhost:8080/newmapping" method="post" target="_blank">
        <label for="urlShort">Short Url: http://localhost:8080/</label>
        <input type="text" id="urlShort" name="urlShort"><br><br>
        <label for="urlLong">Long Url:</label>
        <input type="text" id="urlLong" name="urlLong"><br><br>
        <input type="submit" value="Submit">
    </form>

    <script>
        function addNewMapping( event ) {
            event.preventDefault();

            const xhr = new XMLHttpRequest();

            // listen for `load` event
            xhr.onload = () => {
                // print JSON response
                if (xhr.status >= 200 && xhr.status < 300) {
                    location.reload();
                }
            };

            // create a JSON object
            var data = { urlShort: document.getElementById( 'urlShort' ).value,
                urlLong: document.getElementById( 'urlLong' ).value };

            // open request
            xhr.open('POST', 'http://localhost:8080/newmapping');

            // set `Content-Type` header
            xhr.setRequestHeader('Content-Type', 'application/json');

            // send rquest with JSON payload
            xhr.send(JSON.stringify( data ));
        }

        const form = document.getElementById( 'addNewMappingForm' );
        form.addEventListener( 'submit', function( event) { addNewMapping( event ) } )

        async function loadMappings() {
            const response = await fetch('http://localhost:8080/allmappings', { method: 'GET' });
            const data = await response.json();

            let table = document.getElementById("mappingTable");
            let i = 1;
            console.log(response);
            console.log(data);
            data.forEach(element => {
                let row = table.insertRow(i);
                row.insertCell(0).innerHTML = element.id;
                row.insertCell(1).innerHTML = element.urlShort;
                row.insertCell(2).innerHTML = element.urlLong;
                row.insertCell(3).innerHTML = element.counter;
                i++;
            });
        }

        loadMappings();
    </script>

</body>

</html>